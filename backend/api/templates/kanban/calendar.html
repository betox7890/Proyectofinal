{% extends 'kanban/base.html' %}
{% load static %}

{% block body_class %}board-page{% endblock %}
{% block body_style %}--board-overlay-color: {{ board_overlay_color }}; --board-background-image: url('{{ board_background_image }}');{% endblock %}

{% block content %}
<div class="board-container">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="calendar-container">
        <div class="calendar-header">
            <h1>Calendario de Vencimientos</h1>
            <div class="calendar-header-actions">
                <button class="btn-send-email" onclick="showEmailModal()" title="Enviar recordatorios por correo">üìß Enviar Recordatorios</button>
                <a href="{% url 'kanban:board' %}" class="btn-back-board">‚Üê Volver al tablero</a>
            </div>
        </div>

        <div class="calendar-summary">
            <div class="calendar-card">
                <strong>{{ total_items }}</strong>
                Elementos totales
            </div>
            <div class="calendar-card">
                <strong>{{ overdue_count }}</strong>
                Vencidos
            </div>
            <div class="calendar-card">
                <strong>{{ soon_count }}</strong>
                Vencen pronto (‚â§ 3 d√≠as)
            </div>
        </div>

        <div class="mini-calendar">
            <div class="mini-calendar-header">
                <button type="button" class="mini-cal-btn" id="miniCalPrev">‚Äπ</button>
                <span id="miniCalTitle"></span>
                <button type="button" class="mini-cal-btn" id="miniCalNext">‚Ä∫</button>
            </div>
            <table class="mini-calendar-table">
                <thead>
                    <tr>
                        <th>do.</th>
                        <th>lu.</th>
                        <th>ma.</th>
                        <th>mi.</th>
                        <th>ju.</th>
                        <th>vi.</th>
                        <th>sa.</th>
                    </tr>
                </thead>
                <tbody id="miniCalBody"></tbody>
            </table>
            <div class="mini-calendar-legend">
                <span class="legend-item due-overdue">Vencido</span>
                <span class="legend-item due-soon">Pronto a vencer</span>
                <span class="legend-item due-ok">En plazo</span>
            </div>
        </div>

        {% if calendar_items %}
        <table class="calendar-table">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>T√≠tulo</th>
                    <th>Lista</th>
                    <th>Pertenece a</th>
                    <th>Responsable</th>
                    <th>Fecha de vencimiento</th>
                    <th>Tiempo restante</th>
                </tr>
            </thead>
            <tbody>
                {% for item in calendar_items %}
                <tr>
                    <td>
                        <span class="badge-type {% if item.type == 'Subtarea' %}badge-subtask{% endif %}">{{ item.type }}</span>
                    </td>
                    <td>{{ item.title }}</td>
                    <td>{{ item.list_name }}</td>
                    <td>{% if item.parent %}{{ item.parent }}{% else %}-{% endif %}</td>
                    <td>{{ item.created_by }}</td>
                    <td>{{ item.due_date|date:"d/m/Y" }}</td>
                    <td>
                        {% if item.status == 'overdue' %}
                            <span class="badge-overdue">Vencido hace {{ item.due_in_abs }} d√≠a{% if item.due_in_abs != 1 %}s{% endif %}</span>
                        {% elif item.status == 'soon' %}
                            <span class="badge-soon">Vence en {{ item.due_in }} d√≠a{% if item.due_in != 1 %}s{% endif %}</span>
                        {% elif item.status == 'ok' %}
                            <span class="badge-ok">Vence en {{ item.due_in }} d√≠a{% if item.due_in != 1 %}s{% endif %}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="calendar-empty">
            No hay tareas ni subtareas registradas.
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para env√≠o de correos -->
<div id="emailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEmailModal()">&times;</span>
        <h3>üìß Enviar Recordatorios por Correo</h3>
        <div class="email-form">
            <p class="email-description">
                Selecciona qu√© tipo de recordatorios deseas enviar. Los correos se enviar√°n a los responsables de las tareas y subtareas.
            </p>
            
            <div class="email-options">
                <label class="email-option">
                    <input type="checkbox" id="emailOverdue" checked>
                    <span>Tareas y subtareas vencidas</span>
                </label>
                <label class="email-option">
                    <input type="checkbox" id="emailSoon" checked>
                    <span>Tareas y subtareas que vencen en 1-3 d√≠as</span>
                </label>
                <label class="email-option">
                    <input type="checkbox" id="emailWeek">
                    <span>Tareas y subtareas que vencen en 4-7 d√≠as</span>
                </label>
            </div>

            <div class="email-actions">
                <button type="button" class="btn-submit" onclick="sendEmailReminders()">
                    üìß Enviar Recordatorios
                </button>
                <button type="button" class="btn-cancel" onclick="closeEmailModal()">
                    Cancelar
                </button>
            </div>

            <div id="emailStatus" class="email-status" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const miniCalendarEvents = JSON.parse('{{ calendar_events_json|escapejs }}');
const eventPriority = { 'overdue': 3, 'soon': 2, 'ok': 1 };
const monthNames = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];

const eventMap = {};
miniCalendarEvents.forEach(evt => {
    if (!evt.date) return;
    if (!eventMap[evt.date] || eventPriority[evt.status] > (eventPriority[eventMap[evt.date].status] || 0)) {
        eventMap[evt.date] = evt;
    }
});

const today = new Date();
let miniCalYear = today.getFullYear();
let miniCalMonth = today.getMonth();

const titleEl = document.getElementById('miniCalTitle');
const bodyEl = document.getElementById('miniCalBody');
const prevBtn = document.getElementById('miniCalPrev');
const nextBtn = document.getElementById('miniCalNext');

function pad(num) {
    return num < 10 ? '0' + num : '' + num;
}

function renderMiniCalendar() {
    const firstDay = new Date(miniCalYear, miniCalMonth, 1);
    const startingDay = firstDay.getDay(); // 0 domingo
    const daysInMonth = new Date(miniCalYear, miniCalMonth + 1, 0).getDate();

    titleEl.textContent = `${monthNames[miniCalMonth]} de ${miniCalYear}`;
    bodyEl.innerHTML = '';

    let date = 1;
    for (let row = 0; row < 6; row++) {
        let rowHtml = '<tr>';
        for (let col = 0; col < 7; col++) {
            if (row === 0 && col < startingDay) {
                rowHtml += '<td></td>';
            } else if (date > daysInMonth) {
                rowHtml += '<td></td>';
            } else {
                const isoDate = `${miniCalYear}-${pad(miniCalMonth + 1)}-${pad(date)}`;
                const event = eventMap[isoDate];
                let className = '';
                if (event && event.status === 'overdue') className = 'due-overdue';
                else if (event && event.status === 'soon') className = 'due-soon';
                else if (event && event.status === 'ok') className = 'due-ok';
                else if (today.getFullYear() === miniCalYear && today.getMonth() === miniCalMonth && today.getDate() === date) className = 'today';

                rowHtml += `<td><span class="${className}">${date}</span></td>`;
                date++;
            }
        }
        rowHtml += '</tr>';
        bodyEl.insertAdjacentHTML('beforeend', rowHtml);
        if (date > daysInMonth) break;
    }
}

prevBtn.addEventListener('click', () => {
    miniCalMonth--;
    if (miniCalMonth < 0) {
        miniCalMonth = 11;
        miniCalYear--;
    }
    renderMiniCalendar();
});

nextBtn.addEventListener('click', () => {
    miniCalMonth++;
    if (miniCalMonth > 11) {
        miniCalMonth = 0;
        miniCalYear++;
    }
    renderMiniCalendar();
});

document.addEventListener('DOMContentLoaded', renderMiniCalendar);

// Funciones para el modal de env√≠o de correos
function showEmailModal() {
    document.getElementById('emailModal').style.display = 'block';
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
    document.getElementById('emailStatus').style.display = 'none';
}

function sendEmailReminders() {
    const emailOverdue = document.getElementById('emailOverdue').checked;
    const emailSoon = document.getElementById('emailSoon').checked;
    const emailWeek = document.getElementById('emailWeek').checked;

    if (!emailOverdue && !emailSoon && !emailWeek) {
        alert('Por favor, selecciona al menos una opci√≥n de recordatorio.');
        return;
    }

    const statusDiv = document.getElementById('emailStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<p>‚è≥ Enviando recordatorios...</p>';
    statusDiv.className = 'email-status email-status-loading';

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.match(/csrftoken=([^;]+)/)?.[1];

    fetch('{% url "kanban:send_calendar_reminders" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            overdue: emailOverdue,
            soon: emailSoon,
            week: emailWeek
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `<p style="color: #10b981;">‚úÖ ${data.message}</p>`;
            statusDiv.className = 'email-status email-status-success';
            if (data.details) {
                statusDiv.innerHTML += `<p style="font-size: 0.9em; margin-top: 10px;">${data.details}</p>`;
            }
        } else {
            statusDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${data.error || 'No se pudieron enviar los correos'}</p>`;
            statusDiv.className = 'email-status email-status-error';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error al enviar los correos. Por favor, intenta nuevamente.</p>`;
        statusDiv.className = 'email-status email-status-error';
    });
}

// Cerrar modal al hacer clic fuera de √©l
window.onclick = function(event) {
    const emailModal = document.getElementById('emailModal');
    if (event.target == emailModal) {
        closeEmailModal();
    }
}
</script>
{% endblock %}
